<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Math Trainer</title>
    <!-- Favicon (the logo for the tab) --><link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3C!-- Background circle to ensure clarity on various browser themes --%3E%3Ccircle cx='50' cy='50' r='48' fill='%231f2937'/%3E%3C!-- Stylized brain shape --%3E%3Cpath d='M50,10 A35,20 0 1,1 25,60 Q30,80 50,90 Q70,80 75,60 A35,20 0 1,1 50,10 Z M50,15 C35,15 25,30 25,50 C25,70 35,85 50,85 C65,85 75,70 75,50 C75,30 65,15 50,15 M50,18 C40,18 32,25 32,45 C32,65 40,78 50,78 C60,78 68,65 68,45 C68,25 60,18 50,18 Z M50,22 C43,22 38,28 38,45 C38,62 43,72 50,72 C57,72 62,62 62,45 C62,28 57,22 50,22 Z' fill='%2334d399'/%3E%3C!-- Subtle flash/starburst effect --%3E%3Cpath d='M50,45 L58,35 L50,30 L42,35 Z M50,55 L58,65 L50,70 L42,65 Z M45,50 L35,58 L30,50 L35,42 Z M55,50 L65,58 L70,50 L65,42 Z' fill='%23e0f7fa' opacity='0.7'/%3E%3C!-- Subtle "7" or "8" hint (optional, if it fits without clutter) --%3E%3C!-- path d='M55 40 L45 40 L45 50 L55 50' fill='%231f2937' opacity='0.2' / --%3E%3C/svg%3E">
    <!-- Load Lora Font --><link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Lora font class */
        .font-lora {
            font-family: 'Lora', serif;
        }
        /* Custom Scrollbar for dark mode aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; /* Darker dark mode */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for the vertical number display area */
        #problem-display {
            min-height: 250px;
            max-height: 40vh;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6);
        }
        /* Custom line for arithmetic separation */
        .addition-line {
            border-top: 2px solid #6b7280;
            margin-top: 4px;
            padding-top: 4px;
        }
        /* Ensures the numbers line up correctly */
        .problem-container {
             display: flex;
             flex-direction: column;
             align-items: flex-end;
             width: 100%;
        }
        .problem-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            width: 100%;
            font-size: 2.25rem; /* 3xl */
            line-height: 1.2;
        }
        .operator {
            width: 1.5rem; /* fixed width for operator */
            text-align: right;
            font-weight: bold;
        }
        .number-box {
            min-width: 50%; /* ensure enough space for numbers */
            text-align: right;
            padding-right: 0.5rem;
        }
        @media (min-width: 640px) {
            .problem-row {
                font-size: 3rem; /* 4xl */
            }
        }
        /* New custom class for review modal size */
        .review-modal-size {
            max-width: 768px; /* md:max-w-3xl */
        }
        /* CSS for the SVG Chart */
        .chart-bar-acc {
            fill: #34d399; /* accent color */
        }
        .chart-bar-speed {
            fill: #f59e0b; /* amber color */
        }
        .chart-bar {
            transition: height 0.5s ease-out;
            cursor: pointer;
        }
        .chart-container {
            position: relative;
        }
        .tooltip {
            position: absolute;
            background-color: #1f2937;
            color: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        /* New darker background */
        .bg-primary-darker { 
            background-color: #111827; /* Very dark slate */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-bg': '#111827', // Darker Dark Mode
                        'secondary-bg': '#1f2937', // Slightly Lighter Slate
                        'accent': '#34d399', // Emerald Green
                        'text-color': '#f3f4f6',
                        'input-bg': '#374151',
                        'error': '#f87171',
                        'success-bg': '#064e3b',
                        'error-bg': '#7f1d1d',
                        'speed-color': '#f59e0b', // Amber/Speed
                        'subtraction-color': '#3b82f6', // Blue
                        'multiplication-color': '#fcd34d', // Yellow
                        'division-color': '#a78bfa', // Purple
                    },
                    fontFamily: {
                        lora: ['Lora', 'serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-primary-bg text-text-color font-lora min-h-screen p-4 flex items-center justify-center">

    <div id="app" class="w-full max-w-2xl bg-secondary-bg p-6 md:p-8 rounded-xl shadow-2xl transition-all duration-300">
        <h1 class="text-3xl font-bold text-center mb-6 text-accent">Vertical Mental Math Builder</h1>

        <!-- Settings Panel --><div id="settings-panel" class="mb-6 space-y-4 p-4 border border-input-bg rounded-lg">
            <h2 class="text-xl font-semibold mb-3 text-white">Custom Settings</h2>
            
            <p id="restart-prompt" class="text-sm text-gray-400 mb-4 h-6">Ready to start?</p>

            <!-- Row 1: Time, Problems, Terms --><div class="grid grid-cols-3 gap-4">
                <div class="col-span-1">
                    <label for="max-time" class="block text-sm font-medium mb-1">Time Limit (sec)</label>
                    <input type="number" id="max-time" value="60" min="10" class="w-full p-2 rounded bg-input-bg border border-input-bg focus:border-accent outline-none transition" />
                </div>
                <div class="col-span-1">
                    <label for="num-problems" class="block text-sm font-medium mb-1">Total Problems</label>
                    <!-- DEFAULT: 10 --><input type="number" id="num-problems" value="10" min="1" max="100" class="w-full p-2 rounded bg-input-bg border border-input-bg focus:border-accent outline-none transition" />
                </div>
                <div class="col-span-1">
                    <label for="num-terms" class="block text-sm font-medium mb-1">Numbers in Column</label>
                    <!-- DEFAULT: 2 --><input type="number" id="num-terms" value="2" min="2" max="15" class="w-full p-2 rounded bg-input-bg border border-input-bg focus:border-accent outline-none transition" />
                </div>
            </div>
            
            <!-- Row 2: Operation, Min/Max Digits --><div class="grid grid-cols-3 gap-4">
                <div class="col-span-1">
                    <label for="operation-type" class="block text-sm font-medium mb-1">Operation</label>
                    <select id="operation-type" class="w-full p-2 rounded bg-input-bg border border-input-bg focus:border-accent outline-none transition">
                        <!-- ADDITION IS NOW DEFAULT -->
                        <option value="+">Addition (+)</option>
                        <option value="mix">Mixed (+, -, x, /)</option>
                        <option value="-">Subtraction (-)</option>
                        <option value="*">Multiplication (x)</option>
                        <option value="/">Division (÷)</option>
                        <!-- NEW OPERATIONS ADDED -->
                        <option value="sq">Squares (Sq)</option>
                        <option value="tbl">Tables (Tbl)</option>
                    </select>
                </div>
                <div class="col-span-1">
                    <label for="min-digits" class="block text-sm font-medium mb-1">Min Digits</label>
                    <!-- DEFAULT: 1 --><input type="number" id="min-digits" value="1" min="1" max="6" class="w-full p-2 rounded bg-input-bg border border-input-bg focus:border-accent outline-none transition" />
                </div>
                <div class="col-span-1">
                    <label for="max-digits" class="block text-sm font-medium mb-1">Max Digits (2 for 99)</label>
                    <!-- DEFAULT: 6 --><input type="number" id="max-digits" value="6" min="1" max="6" class="w-full p-2 rounded bg-input-bg border border-input-bg focus:border-accent outline-none transition" />
                </div>
            </div>
            
            <!-- Removed New Feature 2 (Exclude Negatives) and New Feature 8 (Max Difficulty Toggle) -->

            <button id="start-game" class="w-full mt-4 py-3 bg-accent text-primary-bg font-bold rounded-lg hover:bg-emerald-400 transition transform hover:scale-[1.01] shadow-lg">
                Start Challenge
            </button>
        </div>
        
        <!-- Game Area --><div id="game-area" class="hidden">
            <!-- Removed New Feature 5: Visual Countdown Bar -->

            <!-- Stats Bar --><div class="flex justify-between items-center mb-4 text-lg font-semibold border-b border-input-bg pb-2">
                <div id="progress-tracker" class="text-white">Progress: 0/0</div>
                <!-- Reverted to basic timer display (removed fractional part) -->
                <div id="timer" class="text-accent">Time: 0s</div>
            </div>

            <!-- Problem Display --><div id="problem-display" class="bg-primary-bg p-4 mb-4 text-3xl sm:text-4xl relative">
                <!-- Removed New Feature 9: Dynamic Problem Counter -->
                <div id="q-number-display" class="absolute top-2 left-2 text-lg font-bold text-gray-500">Q0</div>
                <p class="text-center text-lg text-gray-400">Press Start to begin.</p>
            </div>

            <!-- Answer Input and Feedback --><div class="flex flex-col space-y-3">
                <input type="number" id="answer-input" placeholder="Your Answer" disabled
                    class="w-full p-3 text-3xl text-center rounded-lg bg-input-bg border border-input-bg focus:border-accent outline-none transition custom-placeholder" />

                <div class="flex space-x-2">
                    <!-- STOP BUTTON --><button id="stop-game" disabled
                        class="flex-1 py-3 px-6 bg-error text-text-color font-bold rounded-lg hover:bg-red-600 transition transform shadow-lg">
                        Stop
                    </button>
                    <!-- Removed New Feature 3: Session History Button -->
                </div>
                
                <p id="feedback" class="text-center text-xl h-6"></p>
            </div>

            <!-- Gemini Strategy Assistant Feature --><div class="mt-4 pt-4 border-t border-input-bg">
                <button id="get-strategy-tip" disabled
                    class="w-full py-2 bg-secondary-bg text-text-color font-bold rounded-lg border border-accent hover:bg-input-bg transition disabled:opacity-50">
                    ✨ Get Mental Math Strategy
                </button>
                <div id="strategy-tip-output" class="p-3 mt-3 bg-primary-bg rounded-lg text-sm text-gray-400 min-h-[50px]">
                    Solve a problem to get a custom mental math strategy.
                </div>
            </div>

        </div>

        <!-- History Tracker --><div class="mt-8 pt-4 border-t border-input-bg">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold text-white">History Tracker (Last 10 Quizzes)</h2>
                <button id="export-csv" class="text-sm px-3 py-1 bg-gray-600 rounded hover:bg-gray-500 transition disabled:opacity-50" disabled>
                    Export to CSV
                </button>
            </div>

            <!-- Total Stats -->
            <div id="total-stats" class="grid grid-cols-3 gap-4 mb-4 p-3 bg-primary-bg rounded-lg border border-input-bg">
                <div class="text-center">
                    <p class="text-xs text-gray-400 uppercase tracking-wider">Total Correct Answers</p>
                    <p id="total-solved-display" class="text-2xl font-bold text-accent">0</p>
                </div>
                <div class="text-center">
                    <!-- Total Attempted Metric (Kept) -->
                    <p class="text-xs text-gray-400 uppercase tracking-wider">Total Attempted Questions</p>
                    <p id="total-attempted-display" class="text-2xl font-bold text-white">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400 uppercase tracking-wider">Total Time Spent (Minutes)</p>
                    <p id="total-time-display" class="text-2xl font-bold text-speed-color">0</p>
                </div>
                <div class="text-center col-span-3 pt-2">
                     <!-- Fastest Quiz Time (Kept) -->
                     <p class="text-xs text-gray-400 uppercase tracking-wider">Fastest Completed Quiz (min 10 Q)</p>
                     <p id="fastest-quiz-display" class="text-2xl font-bold text-yellow-400">N/A</p>
                </div>
            </div>

            <!-- Performance Chart Area - Reverted to basic chart -->
            <div id="accuracy-chart" class="chart-container h-52 w-full mb-4 rounded-lg bg-primary-bg p-2 flex flex-col justify-center">
                 <p class="text-gray-400 text-sm" id="chart-message">Complete a quiz to see your trend.</p>
            </div>
            
            <div id="history-loading" class="text-center text-gray-400">Loading history...</div>
            <div id="history-table" class="overflow-x-auto">
                <!-- History Table will be injected here --></div>
        </div>
    </div>

    <!-- Modal for Game Over/Results --><div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-secondary-bg p-8 rounded-xl w-full max-w-sm text-center shadow-2xl">
            <h3 id="modal-title" class="text-3xl font-bold mb-4 text-accent">Time's Up!</h3>
            <div id="modal-message" class="text-xl mb-6 space-y-2">
                <!-- Results injected here --></div>
            <div id="modal-actions" class="flex flex-col space-y-3">
                 <button id="review-problems" class="py-2 px-6 bg-gray-600 text-text-color font-bold rounded-lg hover:bg-gray-500 transition">
                    Review Problems
                </button>
                <button id="close-modal" class="py-2 px-6 bg-accent text-primary-bg font-bold rounded-lg hover:bg-emerald-400 transition">
                    New Game
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Reviewing Problems (Hidden by default) --><div id="review-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-secondary-bg p-6 rounded-xl w-full review-modal-size max-h-[90vh] overflow-y-auto shadow-2xl">
            <h3 class="text-2xl font-bold mb-4 text-accent border-b border-input-bg pb-2">Problem Review</h3>
            <div id="review-list" class="space-y-4">
                <!-- Detailed problem list injected here --></div>
            <button id="close-review-modal" class="w-full mt-6 py-2 px-6 bg-gray-600 text-text-color font-bold rounded-lg hover:bg-gray-500 transition">
                Close Review
            </button>
        </div>
    </div>

    <!-- Removed New Feature 3: Session Log Modal -->
    
    <!-- Tooltip Element for Charts --><div id="chart-tooltip" class="tooltip"></div>

    <script type="module">
        // --- Persistence Keys ---
        const HISTORY_STORAGE_KEY = 'mentalMathHistory';
        const SETTINGS_STORAGE_KEY = 'mentalMathSettings'; 
        
        // Global variables for game state
        let maxTime, numProblems, numTerms, maxDigits, minDigits;
        let operationType;
        let currentProblem = null;
        let currentProblemIndex = 0;
        let score = 0;
        let timerInterval = null;
        let startTime; // Stores the moment the game started (for total time calc)
        let timeLeft;
        let isGameRunning = false;
        let results = [];
        let problemStartTime;
        let correctProblemTimes = [];
        let recentCorrectTimes = [];

        // --- DOM Elements ---
        const $settingsPanel = document.getElementById('settings-panel');
        const $gameArea = document.getElementById('game-area');
        const $startButton = document.getElementById('start-game');
        const $answerInput = document.getElementById('answer-input');
        const $timer = document.getElementById('timer');
        const $progressTracker = document.getElementById('progress-tracker');
        const $feedback = document.getElementById('feedback');
        const $operationType = document.getElementById('operation-type');
        
        // Total Stats & History
        const $totalSolvedDisplay = document.getElementById('total-solved-display');
        const $totalAttemptedDisplay = document.getElementById('total-attempted-display'); 
        const $totalTimeDisplay = document.getElementById('total-time-display');
        const $fastestQuizDisplay = document.getElementById('fastest-quiz-display'); 
        const $historyTable = document.getElementById('history-table');
        const $historyLoading = document.getElementById('history-loading');
        const $exportCsvButton = document.getElementById('export-csv');
        const $accuracyChart = document.getElementById('accuracy-chart');
        
        // Modals
        const $modal = document.getElementById('modal');
        const $modalTitle = document.getElementById('modal-title');
        const $modalMessage = document.getElementById('modal-message');
        const $closeModal = document.getElementById('close-modal');
        const $reviewProblemsButton = document.getElementById('review-problems');
        const $reviewModal = document.getElementById('review-modal');
        const $closeReviewModal = document.getElementById('close-review-modal');
        const $stopButton = document.getElementById('stop-game');
        
        // Gemini
        const $getStrategyTipButton = document.getElementById('get-strategy-tip');
        const $strategyTipOutput = document.getElementById('strategy-tip-output');
        const $chartTooltip = document.getElementById('chart-tooltip');
        const $restartPrompt = document.getElementById('restart-prompt'); 
        const $problemDisplay = document.getElementById('problem-display'); 
        const $qNumberDisplay = document.getElementById('q-number-display'); 
        
        // Placeholder for removed feature (default: true)
        const $excludeNegatives = { checked: true };


        // --- Persistence (Local Storage) Logic ---

        function saveSettings() {
            try {
                const settings = {
                    op: $operationType.value,
                    minD: document.getElementById('min-digits').value,
                    maxD: document.getElementById('max-digits').value,
                    terms: document.getElementById('num-terms').value,
                    maxT: document.getElementById('max-time').value,
                    // Note: Exclude Negatives and Max Difficulty settings are not saved/loaded in this version
                };
                localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
                updateRestartPrompt(settings);
            } catch (e) {
                console.warn("Could not save settings to Local Storage:", e);
            }
        }
        
        function loadSettings() {
            try {
                const settingsJson = localStorage.getItem(SETTINGS_STORAGE_KEY);
                const settings = settingsJson ? JSON.parse(settingsJson) : {};
                
                if (settings.op) $operationType.value = settings.op;
                if (settings.minD) document.getElementById('min-digits').value = settings.minD;
                if (settings.maxD) document.getElementById('max-digits').value = settings.maxD;
                if (settings.terms) document.getElementById('num-terms').value = settings.terms;
                if (settings.maxT) document.getElementById('max-time').value = settings.maxT;
                
                updateRestartPrompt(settings);
            } catch (e) {
                console.warn("Could not load settings from Local Storage:", e);
            }
        }

        function updateRestartPrompt(settings) {
            if (settings.op) {
                const opName = $operationType.options[$operationType.selectedIndex].text;
                $restartPrompt.textContent = `Last run: ${opName} (${settings.minD}-${settings.maxD}D, ${settings.terms} terms, ${settings.maxT}s).`;
            }
        }
        
        function loadHistory() {
            try {
                const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
                const allHistory = historyJson ? JSON.parse(historyJson) : [];
                
                allHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                let totalSolved = 0;
                let totalAttempted = 0; 
                let totalTimeSeconds = 0;
                let fastestQuizTime = Infinity;

                allHistory.forEach(data => {
                    totalSolved += parseInt(data.score || 0);
                    totalTimeSeconds += parseFloat(data.timeUsed || 0);
                    totalAttempted += parseInt(data.numProblems || 0);
                    
                    if (data.numProblems >= 10 && data.score === data.numProblems) {
                        const time = parseFloat(data.timeUsed);
                        if (time < fastestQuizTime) {
                            fastestQuizTime = time;
                        }
                    }
                });

                const totalTimeMinutes = (totalTimeSeconds / 60).toFixed(0);

                const tableHistory = allHistory.slice(0, 10);
                
                const totals = { 
                    totalSolved, 
                    totalAttempted,
                    totalTime: totalTimeMinutes,
                    fastestQuiz: fastestQuizTime === Infinity ? 'N/A' : `${fastestQuizTime.toFixed(0)}s`,
                };

                renderHistory(tableHistory, totals);
                renderChart(allHistory); 

                if (allHistory.length > 0) {
                    $exportCsvButton.disabled = false;
                    $exportCsvButton.onclick = () => downloadHistoryAsCSV(allHistory);
                } else {
                    $exportCsvButton.disabled = true;
                }
                
                $historyLoading.classList.add('hidden');
                $historyTable.classList.remove('hidden');

            } catch (error) {
                console.error("Error loading history from localStorage:", error);
                $historyLoading.textContent = "History persistence failed in this browser.";
                $totalSolvedDisplay.textContent = 'N/A';
                $totalAttemptedDisplay.textContent = 'N/A';
                $totalTimeDisplay.textContent = 'N/A';
            }
        }

        function saveResult(stats) {
            try {
                const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
                const allHistory = historyJson ? JSON.parse(historyJson) : [];
                
                stats.timestamp = new Date().toISOString(); 
                
                allHistory.push(stats);

                if (allHistory.length > 200) {
                     allHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                     allHistory.splice(200);
                }

                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(allHistory));
                console.log("Result saved to localStorage.");
                
                loadHistory(); 

            } catch (e) {
                console.error("Error saving document to localStorage: ", e);
                $feedback.innerHTML = `<span class="text-error">Error saving history locally.</span>`;
            }
        }
        
        // Reverted difficulty score calculation to simplified version (or removed)
        function calculateDifficultyScore(op, numDigits, numTerms) {
            return 'N/A'; 
        }

        function renderHistory(history, totals) {
            $totalSolvedDisplay.textContent = totals.totalSolved.toLocaleString();
            $totalAttemptedDisplay.textContent = totals.totalAttempted.toLocaleString();
            $totalTimeDisplay.textContent = totals.totalTime.toLocaleString();
            $fastestQuizDisplay.textContent = totals.fastestQuiz;


            if (history.length === 0) {
                $historyTable.innerHTML = `<p class="text-center text-gray-400">No recent results saved yet. Start a quiz!</p>`;
                $historyLoading.classList.add('hidden');
                return;
            }

            const rows = history.map(item => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'short' });
                const fastestTime = item.fastestTime !== 'N/A' ? `<span class="text-accent">${item.fastestTime}s</span>` : 'N/A';
                const accuracyColor = item.accuracy >= 90 ? 'text-accent' : item.accuracy >= 70 ? 'text-yellow-400' : 'text-error';

                // Difficulty Score removed from display
                const difficultyScore = item.difficultyScore || 'N/A';


                return `
                    <tr class="border-t border-input-bg hover:bg-input-bg transition">
                        <td class="px-2 py-3 text-sm font-semibold">${formattedDate} <span class="text-gray-400">(${dayOfWeek})</span></td>
                        <td class="px-2 py-3 text-sm">${item.operation}</td>
                        <td class="px-2 py-3 text-sm ${accuracyColor}">${item.score}/${item.numProblems}</td>
                        <td class="px-2 py-3 text-sm">${item.timeUsed}s</td>
                        <td class="px-2 py-3 text-sm">${fastestTime}</td>
                        <td class="px-2 py-3 text-sm text-gray-400">N/A</td> 
                    </tr>
                `;
            }).join('');

            $historyTable.innerHTML = `
                <table class="min-w-full divide-y divide-input-bg text-text-color">
                    <thead>
                        <tr class="text-xs font-medium uppercase tracking-wider text-gray-400">
                            <th class="px-2 py-2 text-left">Date</th>
                            <th class="px-2 py-2 text-left">Op</th>
                            <th class="px-2 py-2 text-left">Score</th>
                            <th class="px-2 py-2 text-left">Total Time</th>
                            <th class="px-2 py-2 text-left">Fastest</th>
                            <th class="px-2 py-2 text-left">Settings</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-input-bg">
                        ${rows}
                    </tbody>
                </table>
            `;
            $historyLoading.classList.add('hidden');
        }
        
        /**
         * Renders an SVG chart showing accuracy and average speed of the last 10 quizzes.
         */
        function renderChart(history) {
            // Reverting to the simpler dual chart display for accuracy and speed
            const data = history.filter(item => item.title !== 'Challenge Stopped')
                                .slice(0, 10).map(item => ({ 
                accuracy: parseFloat(item.accuracy),
                timeUsed: parseFloat(item.timeUsed),
                numProblems: parseInt(item.numProblems),
                op: item.operation,
            })).reverse(); 
            
            if (data.length === 0) {
                $accuracyChart.innerHTML = '<p class="text-gray-400 text-sm" id="chart-message">Complete a quiz to see your trend.</p>';
                return;
            }
            
            $accuracyChart.innerHTML = '';
            
            const width = 300;
            const height = 120;
            const barCount = data.length;
            const barWidth = width / (barCount * 1.5);
            const gap = barWidth / 2;
            
            const atppData = data.map(item => item.timeUsed / item.numProblems);
            const maxAtpp = Math.max(...atppData) * 1.1; 
            const minAtpp = Math.min(...atppData);
            const rangeAtpp = maxAtpp - minAtpp;
            
            // --- CHART 1: ACCURACY ---
            let svgAcc = `<svg viewBox="0 0 ${width} ${height / 2}" class="w-full h-1/2">`;
            const hAcc = height / 2;
            const y50 = hAcc - (hAcc * 0.5) * 0.9;
            svgAcc += `<line x1="0" y1="${y50}" x2="${width}" y2="${y50}" stroke="#4b5563" stroke-dasharray="2" stroke-width="0.5" />`;
            svgAcc += `<text x="${width - 10}" y="${y50 - 2}" font-size="8" fill="#9ca3af" text-anchor="end">50% Accuracy</text>`;

            data.forEach((item, index) => {
                const barHeightAcc = item.accuracy * 0.9;
                const x = index * (barWidth + gap) + (gap / 2);
                const yAcc = hAcc - barHeightAcc;

                const tooltipText = `Quiz ${index + 1} (${item.op}): Acc=${item.accuracy}%, ATPP=${atppData[index].toFixed(1)}s`;

                svgAcc += `<rect 
                    x="${x}" 
                    y="${yAcc}" 
                    width="${barWidth}" 
                    height="${barHeightAcc}" 
                    class="chart-bar chart-bar-acc" 
                    rx="2"
                    ry="2"
                    onmouseover="showTooltip(evt, '${tooltipText}')"
                    onmouseout="hideTooltip()"
                />`;
                
                if (item.accuracy > 10) {
                    svgAcc += `<text x="${x + barWidth / 2}" y="${yAcc - 2}" font-size="8" fill="${item.accuracy == 100 ? '#34d399' : '#f3f4f6'}" text-anchor="middle">${item.accuracy}</text>`;
                }
            });

            svgAcc += `</svg>`;
            
            // --- CHART 2: ATPP (Average Time Per Problem) ---
            let svgAtpp = `<svg viewBox="0 0 ${width} ${height / 2}" class="w-full h-1/2">`;
            const hAtpp = height / 2;
            svgAtpp += `<text x="${width - 10}" y="10" font-size="8" fill="#f59e0b" text-anchor="end">${maxAtpp.toFixed(1)}s (Slowest)</text>`;
            svgAtpp += `<text x="${width - 10}" y="${hAtpp - 5}" font-size="8" fill="#34d399" text-anchor="end">${minAtpp.toFixed(1)}s (Fastest)</text>`;
            
            data.forEach((item, index) => {
                const atpp = atppData[index];
                
                const normalizedHeight = rangeAtpp > 0 ? ((maxAtpp - atpp) / rangeAtpp) : 0.5;
                const barHeightAtpp = normalizedHeight * (hAtpp * 0.9);
                const yAtpp = hAtpp - barHeightAtpp;

                const tooltipText = `Quiz ${index + 1} (${item.op}): Acc=${item.accuracy}%, ATPP=${atpp.toFixed(1)}s`;

                 svgAtpp += `<rect 
                    x="${index * (barWidth + gap) + (gap / 2)}" 
                    y="${yAtpp}" 
                    width="${barWidth}" 
                    height="${barHeightAtpp}" 
                    class="chart-bar chart-bar-speed" 
                    rx="2"
                    ry="2"
                    onmouseover="showTooltip(evt, '${tooltipText}')"
                    onmouseout="hideTooltip()"
                />`;

            });

            svgAtpp += `</svg>`;

            $accuracyChart.innerHTML = `
                <div class="text-sm font-semibold text-gray-300 w-full px-2">Accuracy Trend (%)</div>
                ${svgAcc}
                <div class="text-sm font-semibold text-gray-300 w-full px-2 mt-2">Speed Trend (ATPP)</div>
                ${svgAtpp}
            `;
        }
        
        window.showTooltip = function(evt, text) {
            $chartTooltip.textContent = text;
            $chartTooltip.style.left = (evt.clientX + 10) + 'px';
            $chartTooltip.style.top = (evt.clientY - 10) + 'px';
            $chartTooltip.style.opacity = 1;
        };

        window.hideTooltip = function() {
            $chartTooltip.style.opacity = 0;
        };


        function downloadHistoryAsCSV(history) {
            if (history.length === 0) {
                console.warn('No history data to export!'); 
                return;
            }

            const header = [
                "Date", "Day", "Operation", "Score (Correct)", "Total Problems (Attempted)", 
                "Accuracy (%)", "Time Used (s)", "Fastest Correct Time (s)", 
                "Min Digits", "Max Digits", "Num Terms", "Fastest Quiz Time (s)"
            ].join(',');
            
            const csvRows = history.map(item => {
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString('en-US');
                const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'long' });
                
                const fastestTime = item.fastestTime !== 'N/A' ? item.fastestTime : '';
                const timeUsed = item.timeUsed;
                const accuracy = item.accuracy;
                
                const isFastestQuiz = item.numProblems >= 10 && item.score === item.numProblems;
                const fastestQuiz = isFastestQuiz ? item.timeUsed : '';
                // Difficulty Score removed from CSV logic

                return [
                    `"${formattedDate}"`,
                    `"${dayOfWeek}"`,
                    `"${item.operation}"`,
                    item.score,
                    item.numProblems, 
                    accuracy,
                    timeUsed,
                    fastestTime,
                    item.minDigits || 'N/A',
                    item.maxDigits,
                    item.numTerms,
                    fastestQuiz
                ].join(',');
            });

            const csvContent = header + '\n' + csvRows.join('\n');
            // FIX: Changed mimeType and filename to .csv for better compatibility with Google Sheets import 
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            // Changed filename extension to .csv for general compatibility and instruction to load into sheets
            link.setAttribute('download', 'mental_math_history.csv'); 
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            $feedback.textContent = 'History exported to CSV! Open it directly in Google Sheets.';
            $feedback.className = 'text-center text-xl h-6 text-accent font-semibold';
            setTimeout(() => $feedback.textContent = '', 5000);
        }
        
        // --- Gemini API Logic ---
        const apiKey = ""; 
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        async function fetchWithBackoff(apiCall, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        async function getStrategyTip(problem) {
            $strategyTipOutput.innerHTML = `<p class="text-accent animate-pulse">Analyzing problem and fetching strategy...</p>`;
            $getStrategyTipButton.disabled = true;

            const op = problem.rawOperator;
            const numTerms = problem.numbers.length;
            const minNumber = Math.min(...problem.numbers);
            const maxNumber = Math.max(...problem.numbers);
            
            let operationName;
            let example;

            switch (op) {
                case 'sq':
                    operationName = 'squaring a number';
                    example = `The number to square is between ${minNumber} and ${maxNumber}.`;
                    break;
                case 'tbl':
                    operationName = 'multiplication tables';
                    example = `The first factor is between 1 and 12, and the second factor is between ${minNumber} and ${maxNumber}.`;
                    break;
                case '+':
                case '-':
                    operationName = numTerms > 2 ? `column ${op === '+' ? 'addition' : 'subtraction'}` : `binary ${op === '+' ? 'addition' : 'subtraction'}`;
                    example = `Numbers are between ${minNumber} and ${maxNumber}.`;
                    break;
                case '*':
                case '/':
                    operationName = op === '*' ? 'binary multiplication' : 'binary division';
                    example = `Numbers are between ${minNumber} and ${maxNumber}.`;
                    break;
                default:
                    operationName = 'general arithmetic';
                    example = `The current operation involves terms between ${minNumber} and ${maxNumber}.`;
            }
            
            let userQuery = `Provide a single, specific, and actionable mental math strategy for solving ${operationName}. The strategy should be concise (1-2 sentences) and highly focused. ${example}`;
            
            const systemPrompt = "You are a world-class mental math coach. Provide a powerful, concise mental math technique for the given arithmetic problem type. Do not provide greetings or conversational filler; just state the strategy.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithBackoff(() => fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    $strategyTipOutput.innerHTML = `<p class="text-white font-semibold">✨ Strategy Tip:</p><p class="mt-1">${text}</p>`;
                } else {
                    $strategyTipOutput.innerHTML = `<p class="text-error">Could not fetch strategy. The LLM response was empty.</p>`;
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                $strategyTipOutput.innerHTML = `<p class="text-error">Error connecting to the strategy coach. Please try again.</p>`;
            } finally {
                 $getStrategyTipButton.disabled = false;
            }
        }

        // --- Utility Functions ---

        function getRandomNumber(minDigits, maxDigits) {
            const min = Math.pow(10, minDigits - 1);
            const max = Math.pow(10, maxDigits) - 1;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateProblem() {
            let rawOperator = operationType;
            let currentNumTerms = numTerms;
            let numbers = [];
            let result;

            // Mix logic updated to include new operations
            if (rawOperator === 'mix') {
                rawOperator = ['+', '-', '*', '/', 'sq', 'tbl'][Math.floor(Math.random() * 6)];
            }
            
            // Multiplication, Division, Squares, and Tables must be binary (2-term logic)
            if (['*', '/', 'sq', 'tbl'].includes(rawOperator)) {
                currentNumTerms = 2; 
            }

            if (rawOperator === '+') {
                // Column Addition
                for (let i = 0; i < currentNumTerms; i++) {
                    numbers.push(getRandomNumber(minDigits, maxDigits));
                }
                result = numbers.reduce((sum, num) => sum + num, 0);

            } else if (rawOperator === '-') {
                // Column Subtraction (running subtraction)
                const excludeNegatives = $excludeNegatives.checked; 
                
                let startingMinDigits = maxDigits; 
                if (maxDigits >= 2 && currentNumTerms > 2) {
                     startingMinDigits = maxDigits + 1; 
                }
                let numA = getRandomNumber(startingMinDigits, maxDigits + 1); 
                numbers.push(numA);
                result = numA;

                // Subtract the remaining terms
                for (let i = 1; i < currentNumTerms; i++) {
                    let numB = getRandomNumber(minDigits, maxDigits);
                    
                    if (excludeNegatives && result < numB) { 
                        numB = Math.floor(result / 2) + 1; 
                        if (numB <= 0) numB = 1; 
                    }

                    numbers.push(numB);
                    result -= numB;
                }
                
            } else if (rawOperator === 'sq') { // SQUARES
                let numA = getRandomNumber(minDigits, maxDigits);
                result = numA * numA;
                numbers = [numA]; // Single number, treated as 2-term logic for flow
                currentNumTerms = 1; // Only one base number in display
            } else if (rawOperator === 'tbl') { // TABLES
                let numA = Math.floor(Math.random() * 12) + 1; // Table factor 1 to 12
                let numB = getRandomNumber(minDigits, maxDigits);
                
                result = numA * numB;
                numbers = [numA, numB];
            } else { // Multiplication or Division (enforced 2-term)
                let numA = getRandomNumber(minDigits, maxDigits);
                let numB = getRandomNumber(minDigits, maxDigits);
                
                if (numB === 0) numB = 1; 

                if (rawOperator === '*') {
                    result = numA * numB;
                    numbers = [numA, numB];
                } else if (rawOperator === '/') {
                    let divisor = numB;
                    let quotient = getRandomNumber(minDigits, maxDigits);
                    if (quotient === 0) quotient = 1;
                    
                    numA = divisor * quotient;
                    result = quotient;
                    numbers = [numA, divisor];
                }
            }
            
            const displayOperator = rawOperator === '/' ? '÷' : 
                                    rawOperator === '*' ? '×' :
                                    rawOperator === 'sq' ? '²' : 
                                    rawOperator === 'tbl' ? '×' :
                                    rawOperator;
            
            return { numbers, sum: result, operator: displayOperator, rawOperator: rawOperator, numTermsUsed: currentNumTerms };
        }

        function renderProblem() {
            if (!currentProblem) return;

            const numbers = currentProblem.numbers;
            const operator = currentProblem.operator;
            const numTermsUsed = currentProblem.numTermsUsed;
            const correctAnswerLength = String(currentProblem.sum).length; 

            $problemDisplay.innerHTML = '';
            $problemDisplay.className = 'bg-primary-bg p-4 mb-4 text-3xl sm:text-4xl text-white relative';

            const container = document.createElement('div');
            container.className = 'problem-container px-4 py-2 leading-tight';

            // Set dynamic max length for input (Kept)
            $answerInput.maxLength = correctAnswerLength;
            
            // Dynamic Problem Counter (Kept)
            $qNumberDisplay.textContent = `Q${currentProblemIndex}`;
            $problemDisplay.prepend($qNumberDisplay);

            if (currentProblem.rawOperator === 'sq') { // SQUARES DISPLAY
                const numA = numbers[0];
                const opColor = 'text-yellow-400';
                
                container.innerHTML = `
                    <div class="problem-row font-mono justify-end">
                        <span class="operator text-primary-bg opacity-0">.</span>
                        <span class="number-box text-5xl">${numA}</span>
                        <sup class="${opColor} text-3xl font-bold ml-1 align-top">2</sup>
                    </div>
                    <div class="addition-line w-full"></div>
                `;
            }
            // Check if it's multi-term addition OR multi-term subtraction (Num Terms > 2)
            else if (numTermsUsed > 2) {
                // Multi-term Column (Addition or Subtraction)
                const columnOperator = currentProblem.rawOperator;
                const opDisplay = columnOperator === '+' ? '+' : '−';
                const opColor = columnOperator === '+' ? 'text-accent' : 'text-subtraction-color';

                const maxLen = numbers.reduce((max, num) => Math.max(max, String(num).length), 0);
                const lastIndex = numbers.length - 1;
                
                numbers.forEach((num, index) => {
                    const numString = String(num);
                    const paddedNum = ' '.repeat(maxLen - numString.length) + numString;
                    
                    const row = document.createElement('div');
                    row.className = 'problem-row font-mono';
                    
                    const opSpan = document.createElement('span');

                    const isOperatorRow = index === lastIndex - 1; 

                    opSpan.textContent = opDisplay;
                    opSpan.className = 'operator ' + (isOperatorRow ? opColor : 'text-primary-bg opacity-0');
                    row.appendChild(opSpan);

                    const numSpan = document.createElement('span');
                    numSpan.className = 'number-box';
                    numSpan.textContent = paddedNum;
                    row.appendChild(numSpan);

                    container.appendChild(row);
                });

                container.innerHTML += `<div class="addition-line w-full"></div>`;
                
            } else {
                // Binary (2-term) Operation: +, -, *, /, Tbl
                const numA = numbers[0];
                const numB = numbers[1];
                const maxLen2 = Math.max(String(numA).length, String(numB).length);

                const paddedA = ' '.repeat(maxLen2 - String(numA).length) + String(numA);
                const paddedB = ' '.repeat(maxLen2 - String(numB).length) + String(numB);

                const opColor = currentProblem.rawOperator === '+' ? 'text-accent' : 
                                currentProblem.rawOperator === '-' ? 'text-subtraction-color' :
                                ['*', 'tbl'].includes(currentProblem.rawOperator) ? 'text-multiplication-color' :
                                'text-division-color';
                                
                container.innerHTML = `
                    <div class="problem-row font-mono justify-end">
                        <span class="operator text-primary-bg opacity-0">.</span>
                        <span class="number-box text-5xl">${paddedA}</span>
                    </div>
                    <div class="problem-row font-mono justify-end">
                        <span class="operator ${opColor} text-5xl font-bold">${operator}</span>
                        <span class="number-box text-5xl">${paddedB}</span>
                    </div>
                    <div class="addition-line w-full"></div>
                `;
            }

            $problemDisplay.appendChild(container);

            problemStartTime = Date.now();
            $answerInput.value = '';
            $answerInput.focus();
            
            $answerInput.disabled = false;
        }

        function updateStats() {
            const now = Date.now();
            const totalElapsedTime = (now - startTime) / 1000;
            const remaining = maxTime - totalElapsedTime;
            
            // Fractional Timer Display (Reverted to standard seconds)
            timeLeft = Math.max(0, remaining);
            $timer.textContent = `Time: ${timeLeft.toFixed(0)}s`; 

            // Countdown Bar removed (using timer color change instead)
            if (timeLeft <= 10) {
                 $timer.classList.add('text-error');
                 $timer.classList.remove('text-accent');
             } else {
                 $timer.classList.add('text-accent');
                 $timer.classList.remove('text-error');
             }


            $progressTracker.textContent = `Progress: ${currentProblemIndex}/${numProblems}`;
        }

        // --- Mistake Analysis Function ---
        function analyzeMistakes() {
            const errorCounts = { '+': 0, '-': 0, '*': 0, '/': 0, 'sq': 0, 'tbl': 0, 'mix': 0, total: 0 };
            const opMap = { '+': 'Addition', '-': 'Subtraction', '*': 'Multiplication', '/': 'Division', 'sq': 'Squares', 'tbl': 'Tables' };
            let summaryHtml = '';

            results.forEach(item => {
                if (item.rawOperator && errorCounts.hasOwnProperty(item.rawOperator)) {
                    if (!item.isCorrect) {
                        errorCounts[item.rawOperator]++;
                        errorCounts.total++;
                    }
                } else if (item.operation === 'mix' && !item.isCorrect) {
                     errorCounts.mix++;
                     errorCounts.total++;
                }
            });
            
            let weakestOp = null;
            let maxErrors = -1;
            
            for (const op in errorCounts) {
                if (op !== 'total' && op !== 'mix' && errorCounts[op] > maxErrors) {
                    maxErrors = errorCounts[op];
                    weakestOp = op;
                }
            }
            
            if (errorCounts.total === 0) {
                summaryHtml += `<p class="text-accent font-bold">**Outstanding performance!** You completed the challenge with **100% accuracy**.</p>`;
            } else {
                if (weakestOp && maxErrors > 0) {
                     const opName = opMap[weakestOp];
                     summaryHtml += `<p class="text-error font-bold">Your highest error rate (**${maxErrors} errors**) was in **${opName}**.</p>`;
                     summaryHtml += `<p class="text-gray-300 text-sm mt-1">Recommendation: Focus on ${opName} in your next few challenges.</p>`;
                     summaryHtml += `<button data-op="${weakestOp}" class="quick-challenge-button mt-3 py-2 px-4 bg-error text-text-color font-bold rounded-lg hover:bg-red-600 transition text-sm shadow-md w-full">Practice ${opName} Now</button>`;
                }
            }
            
            // Difficulty Scaling logic removed
            // Fastest Problem Review removed
            
            return { summaryHtml };
        }

        // --- Game Flow ---

        function startGame() {
            console.log("Starting Game...");
            
            // 1. Get Settings with Robust Defaulting (FIX: Ensures NaN inputs default to valid numbers)
            maxTime = parseInt(document.getElementById('max-time').value) || 60;
            numProblems = parseInt(document.getElementById('num-problems').value) || 10;
            numTerms = parseInt(document.getElementById('num-terms').value) || 2;
            minDigits = parseInt(document.getElementById('min-digits').value) || 1;
            maxDigits = parseInt(document.getElementById('max-digits').value) || 6;
            operationType = $operationType.value;
            
            // Re-assign values in case they defaulted, so validation checks against the intended number
            document.getElementById('max-time').value = maxTime;
            document.getElementById('num-problems').value = numProblems;
            document.getElementById('num-terms').value = numTerms;
            document.getElementById('min-digits').value = minDigits;
            document.getElementById('max-digits').value = maxDigits;
            
            // Validation (FIX: Added more descriptive error messages)
            if (maxTime < 10) {
                $feedback.textContent = 'Time Limit must be at least 10 seconds.';
                $feedback.className = 'text-center text-xl h-6 text-error';
                return;
            }
            if (numProblems < 1) {
                $feedback.textContent = 'Total Problems must be at least 1.';
                $feedback.className = 'text-center text-xl h-6 text-error';
                return;
            }
            if (minDigits < 1 || maxDigits < 1 || minDigits > maxDigits) {
                $feedback.textContent = 'Check Digits: Min must be 1+ and Max must be equal to or greater than Min.';
                $feedback.className = 'text-center text-xl h-6 text-error';
                return;
            }
            if ((operationType === '+' || operationType === '-') && numTerms < 2) {
                 $feedback.textContent = 'Addition/Subtraction requires at least 2 numbers in the column.';
                 $feedback.className = 'text-center text-xl h-6 text-error';
                 return;
            }

            saveSettings();
            startTime = Date.now(); 

            // 2. Setup State
            currentProblemIndex = 0;
            score = 0;
            timeLeft = maxTime;
            results = [];
            correctProblemTimes = [];
            recentCorrectTimes = [];
            isGameRunning = true;

            // 3. Update UI
            $settingsPanel.classList.add('hidden');
            $gameArea.classList.remove('hidden');
            $answerInput.disabled = false;
            $stopButton.disabled = false; 
            $feedback.textContent = '';
            
            $getStrategyTipButton.disabled = true;
            $strategyTipOutput.innerHTML = `<p class="text-gray-400 text-sm">Solve a problem to get a custom mental math strategy.</p>`;

            $timer.textContent = `Time: ${maxTime}s`;
            $timer.className = 'text-accent';

            // 4. Start Timer (Reverted to simpler single interval)
            startTimer();

            // 5. Generate First Problem
            nextProblem();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            if (!isGameRunning) return; 

            timerInterval = setInterval(() => {
                // Pause on Lost Focus logic removed
                
                const now = Date.now();
                const totalElapsedTime = (now - startTime) / 1000;
                let remaining = maxTime - totalElapsedTime;

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    endGame('Time Up!');
                    return;
                }

                timeLeft = remaining;
                updateStats();
            }, 1000); // Check every second
        }


        function nextProblem() {
            if (currentProblemIndex >= numProblems || !isGameRunning) {
                endGame('Challenge Complete!');
                return;
            }

            currentProblemIndex++;
            currentProblem = generateProblem();
            renderProblem();
            $feedback.textContent = '';
            $answerInput.focus();
            updateStats();
            
            $getStrategyTipButton.disabled = false;
            $getStrategyTipButton.onclick = () => getStrategyTip(currentProblem);
        }

        function submitAnswer(isCorrect, userAnswer) {
            if (!isGameRunning || $answerInput.disabled) return; 

            $answerInput.disabled = true;

            const timeTaken = (Date.now() - problemStartTime) / 1000;
            const correctAnswer = currentProblem.sum;
            
            const opSymbol = currentProblem.rawOperator === '+' ? ' + ' : 
                             currentProblem.rawOperator === '*' ? ' × ' :
                             currentProblem.rawOperator === '/' ? ' ÷ ' :
                             currentProblem.rawOperator === 'sq' ? '²' :
                             currentProblem.rawOperator === 'tbl' ? ' × ' :
                             ' − ';
                             
            // Updated problem string generation for Squares
            const problemString = currentProblem.rawOperator === 'sq' ? `${currentProblem.numbers[0]}${opSymbol}` : currentProblem.numbers.join(opSymbol);

            const result = {
                id: currentProblemIndex,
                problem: problemString,
                correctAnswer: correctAnswer,
                userAnswer: userAnswer,
                isCorrect: isCorrect,
                timeTaken: timeTaken.toFixed(2),
                rawOperator: currentProblem.rawOperator,
                // Difficulty Score removed
            };
            results.push(result);

            let feedbackClass = '';
            let opColorClass = '';
            switch (currentProblem.rawOperator) {
                case '+': opColorClass = 'text-accent'; break;
                case '-': opColorClass = 'text-subtraction-color'; break;
                case '*': 
                case 'tbl': 
                    opColorClass = 'text-multiplication-color'; break;
                case '/': opColorClass = 'text-division-color'; break;
                case 'sq': opColorClass = 'text-yellow-400'; break;
                default: opColorClass = 'text-white';
            }


            if (isCorrect) {
                score++;
                correctProblemTimes.push(timeTaken);
                // Recent correct times for difficulty scaling removed
                
                $feedback.innerHTML = `Correct!`; 
                feedbackClass = `text-center text-xl h-6 text-accent font-semibold`;
            } else {
                // Recent correct times reset removed
                $feedback.innerHTML = `Incorrect! Answer: <span class="${opColorClass} font-bold">${correctAnswer}</span>`;
                feedbackClass = `text-center text-xl h-6 text-error font-semibold`;
            }
            
            $feedback.className = feedbackClass;
            $getStrategyTipButton.disabled = false;
            $getStrategyTipButton.onclick = () => getStrategyTip(currentProblem);

            nextProblem(); 
        }
        
        function checkAndSubmitOnInput() {
            if (!isGameRunning || $answerInput.disabled || !currentProblem) return;

            const inputVal = $answerInput.value.trim();
            const correctAnswer = currentProblem.sum;
            
            // Use Math.abs(currentProblem.sum) for correct length comparison for safety if negatives were allowed
            const expectedLength = String(Math.abs(correctAnswer)).length + (correctAnswer < 0 ? 1 : 0);
            
            if (inputVal === String(correctAnswer)) {
                submitAnswer(true, parseInt(inputVal));
            } else if (inputVal.length >= expectedLength) { // Check for overshoot using >=
                submitAnswer(false, parseInt(inputVal));
            }
        }


        function endGame(title) {
            isGameRunning = false;
            if (timerInterval) clearInterval(timerInterval);

            $answerInput.disabled = true;
            $stopButton.disabled = true;
            $getStrategyTipButton.disabled = true; 

            const totalTimeElapsed = (Date.now() - startTime) / 1000;
            const problemsAttempted = results.length;
            const actualProblems = title === 'Challenge Stopped' ? problemsAttempted : numProblems;
            
            const accuracy = actualProblems > 0 ? ((score / actualProblems) * 100).toFixed(0) : 0;
            
            let timeUsed = title === 'Time Up!' ? maxTime : totalTimeElapsed.toFixed(0);
            
            const fastestTime = correctProblemTimes.length > 0 
                ? Math.min(...correctProblemTimes).toFixed(2)
                : 'N/A';
                
            // Fastest Problem Review removed

            const stats = {
                title: title,
                timestamp: new Date().toISOString(),
                operation: operationType,
                score: score, 
                numProblems: actualProblems,
                accuracy: accuracy,
                timeUsed: timeUsed,
                fastestTime: fastestTime,
                minDigits: minDigits,
                maxDigits: maxDigits,
                numTerms: numTerms,
                // Difficulty Score removed
            };

            const analysis = analyzeMistakes();
            
            const incorrectResults = results.filter(item => !item.isCorrect);
            let mistakesReviewHtml = '';

            if (incorrectResults.length > 0) {
                mistakesReviewHtml = `
                    <div class="mt-4 pt-4 border-t border-input-bg text-sm text-left space-y-2">
                        <h4 class="font-bold text-error mb-2">Mistakes (Answered ${incorrectResults.length} Incorrectly):</h4>
                        ${incorrectResults.map(item => `
                            <div class="p-2 border border-error/50 rounded bg-error-bg/50">
                                <p class="font-semibold">${item.problem}</p>
                                <p class="text-xs">You put: <span class="text-error font-bold">${item.userAnswer || 'N/A'}</span></p>
                                <p class="text-xs">Correct: <span class="text-accent font-bold">${item.correctAnswer}</span></p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }


            saveResult(stats);

            $modalTitle.textContent = title;
            $modalMessage.innerHTML = `
                <p>Questions Attempted: <span class="text-white font-bold">${stats.numProblems}</span></p>
                <p>Correct Answers: <span class="text-accent font-bold">${stats.score}</span></p>
                <p>Accuracy: <span class="text-accent font-bold">${stats.accuracy}%</span></p>
                <p class="mt-4">Total Time Used: <span class="text-accent font-bold">${stats.timeUsed}s</span></p>
                <p>Fastest Correct Answer: <span class="text-accent font-bold">${stats.fastestTime}s</span></p>
                
                <div id="assessment-container" class="mt-4 pt-4 border-t border-input-bg text-sm text-left space-y-2">
                    <h4 class="font-bold text-white">Error Assessment:</h4>
                    ${analysis.summaryHtml}
                </div>
                
                ${mistakesReviewHtml}
            `;
            $modal.classList.remove('hidden');
            
            document.querySelectorAll('.quick-challenge-button').forEach(button => {
                button.addEventListener('click', handleQuickChallenge);
            });
            // Try Harder button logic removed
        }
        
        function handleQuickChallenge(event) {
            const op = event.target.getAttribute('data-op');
            if (op) {
                resetGame(); 
                document.getElementById('operation-type').value = op;
                const opName = $operationType.options[$operationType.selectedIndex].text;
                $feedback.textContent = `Settings updated for **${opName}** practice. Click 'Start Challenge'!`;
                $feedback.className = 'text-center text-xl h-6 text-yellow-400 font-semibold';
            }
        }

        // --- Problem Review Logic (Used by Review Problems) ---
        function renderProblemReview() {
            $modal.classList.add('hidden');
            document.getElementById('review-list').innerHTML = '';
            
            if (results.length === 0) {
                 document.getElementById('review-list').innerHTML = `<p class="text-center text-gray-400">No problems were attempted in this session.</p>`;
                 $reviewModal.classList.remove('hidden');
                 return;
            }

            const reviewHtml = results.map( (item) => {
                const statusClass = item.isCorrect ? 'bg-success-bg' : 'bg-error-bg';
                const statusText = item.isCorrect ? 'Correct' : 'Incorrect';
                
                return `
                    <div class="p-4 rounded-lg ${statusClass} flex justify-between items-center space-x-4">
                        <div class="flex-1 text-left">
                            <p class="text-lg font-semibold mb-1">Q${item.id}: ${item.problem}</p>
                            <p class="text-sm">Your Answer: <span class="font-bold">${item.userAnswer || 'N/A'}</span></p>
                            <p class="text-sm">Correct Answer: <span class="font-bold text-accent">${item.correctAnswer}</span></p>
                        </div>
                        <div class="flex-shrink-0 text-right">
                            <span class="text-sm font-medium block">${statusText}</span>
                            <span class="text-xs text-gray-300 block">${item.timeTaken}s</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('review-list').innerHTML = reviewHtml;
            $reviewModal.classList.remove('hidden');
        }

        function resetGame() {
            saveSettings();
            
            if (timerInterval) clearInterval(timerInterval);

            $modal.classList.add('hidden');
            $reviewModal.classList.add('hidden'); 
            $gameArea.classList.add('hidden');
            $settingsPanel.classList.remove('hidden'); 

            $timer.className = 'text-accent';
            $problemDisplay.innerHTML = '<p class="text-center text-lg text-gray-400">Press Start to begin.</p>';
            $feedback.textContent = ''; 
            $answerInput.value = '';
            $qNumberDisplay.textContent = 'Q0'; 

            loadSettings();
        }
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings(); 
            loadHistory(); 
            
            $startButton.addEventListener('click', startGame);
            $closeModal.addEventListener('click', resetGame);
            $stopButton.addEventListener('click', () => endGame('Challenge Stopped'));
            $reviewProblemsButton.addEventListener('click', renderProblemReview);
            $closeReviewModal.addEventListener('click', () => {
                $reviewModal.classList.add('hidden');
                $modal.classList.remove('hidden'); 
            });
            
            // CORE HIGH-SPEED SUBMISSION LOGIC
            $answerInput.addEventListener('input', checkAndSubmitOnInput);
            
            // NEW: ENTER KEYPRESS LISTENER for starting the game ONLY
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    // Only start the game if the settings panel is visible (i.e., not in the middle of a challenge)
                    if (!$gameArea.classList.contains('hidden')) {
                        return; // Prevent Enter from doing anything while game is active/visible
                    }

                    // Check if the focus is on a field that accepts 'Enter' (like a number input for settings)
                    const activeElement = document.activeElement;
                    const isInputFocused = ['INPUT', 'SELECT'].includes(activeElement.tagName);
                    
                    if (isInputFocused) {
                        // Allow input fields to process Enter (e.g., to confirm input value)
                        // This prevents unexpected trigger unless focus is on the main body or button itself.
                        // We check if the active element is the start button, or if no specific input is focused.
                        return;
                    }
                    
                    // If no relevant input field is focused, assume the user wants to start the game.
                    e.preventDefault(); 
                    if ($settingsPanel.classList.contains('hidden') === false) {
                        $startButton.click();
                    }
                }
            });

            
            // Input change listeners for saving settings
            document.getElementById('max-time').addEventListener('change', saveSettings);
            document.getElementById('num-problems').addEventListener('change', saveSettings);
            document.getElementById('num-terms').addEventListener('change', saveSettings);
            document.getElementById('min-digits').addEventListener('change', saveSettings);
            document.getElementById('max-digits').addEventListener('change', saveSettings);
            document.getElementById('operation-type').addEventListener('change', saveSettings);
            
            // Removed Max Difficulty Toggle and Exclude Negatives listeners/logic
        });

    </script>
</body>
</html>
